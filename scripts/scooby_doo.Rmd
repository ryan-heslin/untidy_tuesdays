---
title: "`r params$title`"
author: "Ryan Heslin"
date: "`r format(Sys.Date(), '%B %e, %Y')`"
header-includes:
  - \setlength{\parindent}{2em}
  - \setlength{\parskip}{2em}
output:
  github_document:
    df_print: "kable"
params:
  title: "Scooby-Doo Analysis"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  comment = "",
  fig.pos = "",
  fig.path = file.path(
    "../figure",
    tools::file_path_sans_ext(
      knitr::current_input()
    ),
    "/"
  ),
  message = FALSE,
  tidy = "styler",
  warning = FALSE,
  fig.align = "center",
  highlight = TRUE
)

library(tidyverse)
```

I was scanning the Tidy Tuesday repo for interesting topics, and I couldn't resist Scooby-Doo.
```{r}
scoobydoo <- readr::read_csv("https://raw.githubusercontent.com/rfordatascience/tidytuesday/master/data/2021/2021-07-13/scoobydoo.csv", na = "NULL")
glimpse(scoobydoo)
theme_standard <- ggplot2::theme(
  panel.background = element_blank(),
  panel.border = element_rect(color = "black", fill = NA),
  panel.grid = element_blank(), panel.grid.major.x = element_line(
    color =
      "gray93"
  ),
  legend.background = element_rect(fill = "gray93"), plot.title = element_text(
    size = 15,
    family = "sans", face = "bold", vjust = 1.3
  ), plot.title.position =
    "plot",
  plot.subtitle = element_text(size = 10, family = "sans"),
  legend.title = element_text(
    size = 10, family = "sans",
    face = "bold"
  ), axis.title = element_text(
    size = 9,
    family = "sans", face = "bold"
  ), axis.text = element_text(
    size = 8,
    family = "sans"
  ), strip.background = element_rect(
    color = "black",
    fill = "black"
  ), strip.text.x = element_text(color = "white"),
  strip.text.y = element_text(color = "white")
)
ggplot2::theme_set(theme_standard)
```

After skimming the variable list, my attention inevitably lands on the `scrappy_doo` indicator. While I sadly am not versed in Scooby-Doo lore, I know Scrappy is widely disliked.


```{r}
logicals <- map_lgl(scoobydoo, ~ any(.x %in% c("TRUE", "FALSE")))
scoobydoo <- mutate(scoobydoo, across(which(logicals), as.logical))
```


Nonetheless, mean IMDB ratings for episodes with Scrappy are not significantly different from those without.
```{r}
t.test(imdb ~ scrappy_doo, data = scoobydoo)
```

He appears in `r round(mean(scoobydoo$scrappy_doo, na.rm = TRUE) * 100)`% of episodes.

To my surprise, there are `r sum(scoobydoo$monster_real, na.rm = TRUE)` episodes with a real monster.

The highest-rated episode is a crossover with _Supernatural_, which makes sense.
```{r}
arrange(scoobydoo, -imdb) |>
  pull(title) |>
  head(10)
```

Ratings seem constant over time, with the exception of a trough in the early 2000s.
```{r, fig.with = 10, fig.height = 10}
filter(scoobydoo, !season %in% c("Crossover", "Movie", "Special")) |>
  mutate(series_name = str_wrap(series_name, 15)) |>
  ggplot(aes(x = date_aired, y = imdb)) +
  geom_line(aes(color = season)) +
  facet_wrap(. ~ series_name, scales = "free_x") +
  scale_x_date(date_labels = "%b %Y") +
  labs(x = "Airdate", color = "Season", title = "IMDB Rating by Season") +
  ylim(c(0, 10)) +
  theme(axis.text.x = element_text(size = 6, angle = 45))
```

The main story of this plot is that Shaggy really likes to say "Zoinks!" They also seem to have toned down the catchphrases in later seasons.
```{r}
phrase_vars <- quote(split_up:rooby_rooby_roo)
scoobydoo |>
  filter(!season %in% c("Crossover", "Movie", "Special")) |>
  group_by(season) |>
  summarize(across(!!phrase_vars, sum, na.rm = TRUE)) |>
  pivot_longer(!!phrase_vars, names_to = "Phrase", values_to = "Count") |>
  mutate(
    Phrase = paste0('"', str_replace_all(str_to_title(Phrase), "_", " "), '!"') |> str_wrap(width = 10),
    Count = ifelse(is.na(Count), 0, Count)
  ) |>
  ggplot(aes(x = Phrase, y = season, fill = Count)) +
  geom_tile(color = "white") +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient(low = "purple", high = "green", trans = "log10", oob = scales::squish_infinite) +
  labs(title = "Phrases Uttered by Season", y = "Season") +
  guides(fill = guide_legend(
    title.position = "top",
    title.hjust = .5
  )) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(size = 8),
    axis.title.x = element_blank(),
    axis.ticks.x = element_blank(),
    plot.title = element_text(hjust = .5),
    legend.background = element_rect(fill = "gray")
  )
```


It seems that "competition" as a villain motive waxed and waned the most over time, peaking in the 1990s. An interesting direction for further analysis.
```{r}
library(gganimate)

year_to_decade <- function(dates) {
  lubridate::year(dates) |>
    as.numeric() |>
    (function(x) x - x %% 10)() |>
    paste0("s")
}
# https://stackoverflow.com/questions/52403952/polar-plot-ggplot2-outer-ring-removed-grid-on-top
scoobydoo <- scoobydoo |>
  mutate(
    decade = year_to_decade(date_aired),
    decade_count = ave(decade, decade, FUN = length) |> as.integer(),
    motive = fct_lump_prop(motive, prop = .02)
  )

p <- scoobydoo |>
  filter(!is.na(motive), !is.na(date_aired)) |>
  group_by(decade) |>
  count(motive, name = "Proportion") |>
  mutate(
    Proportion = Proportion / sum(Proportion),
    ymax = cumsum(Proportion),
    ymin = dplyr::lag(ymax, default = 0),
  ) |>
  ungroup() |>
  ggplot(aes(xmin = 1, xmax = 3.5, ymin = ymin, ymax = ymax, fill = motive)) +
  geom_rect(color = "black") +
  coord_polar(theta = "y") +
  xlim(c(0, 4)) +
  guides(fill = guide_legend(
    title.position = "top",
    title.hjust = .5
  )) +
  labs(fill = "Motive") +
  theme(
    legend.position = "bottom",
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    axis.title.x = element_blank(),
    axis.title.y = element_blank(),
    axis.ticks.x = element_blank(),
    axis.ticks.y = element_blank(),
    legend.key = element_rect(fill = "gray"),
    legend.background = element_rect(fill = "gray"),
    line = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.border = element_blank(),
    plot.title = element_text(hjust = .5),
    plot.subtitle = element_text(hjust = .5)
  )
p + transition_states(decade,
  transition_length = 1, state_length = 3, wrap = TRUE
) +
  ease_aes("linear") +
  enter_drift() +
  exit_drift() +
  ggtitle(label = "Villain Motivations for {closest_state} Episodes", subtitle = paste("n = {scoobydoo |> filter(decade == closest_state)  |> pull(decade_count)  |> unique()}"))
```

>                           close(con)
>                         
> 
> 
